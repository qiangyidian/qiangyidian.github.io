<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>单词拍拍 - Word Snap</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 引入 Tesseract.js -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #000;
            color: white;
            overflow: hidden;
            /* 禁用iOS长按选中文本 */
            -webkit-user-select: none;
            user-select: none;
        }
        
        .scan-line {
            position: absolute;
            width: 100%;
            height: 2px;
            background: #00ff00;
            box-shadow: 0 0 4px #00ff00;
            animation: scan 2s linear infinite;
        }

        @keyframes scan {
            0% { top: 0; opacity: 0; }
            50% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        .hide-scrollbar::-webkit-scrollbar { display: none; }
        .hide-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }

        #video-feed { object-fit: cover; width: 100%; height: 100%; }

        /* 编辑框样式优化 */
        .editable-word {
            background: transparent;
            border-bottom: 2px dashed #cbd5e1;
            text-align: center;
            width: 100%;
            outline: none;
            transition: all 0.3s;
        }
        .editable-word:focus {
            border-bottom: 2px solid #3b82f6;
            background: #eff6ff;
        }
    </style>
</head>
<body class="h-screen w-screen relative">

    <!-- ==================== 页面 1: 摄像头取景 ==================== -->
    <div id="camera-view" class="absolute inset-0 z-10 flex flex-col items-center justify-center">
        <video id="video-feed" autoplay playsinline muted class="absolute inset-0 z-0"></video>

        <div class="absolute inset-0 z-10 flex flex-col pointer-events-none">
            <div class="flex-1 bg-black/60"></div>
            <div class="h-24 flex w-full">
                <div class="flex-1 bg-black/60"></div>
                <!-- 取景框 -->
                <div id="scan-box" class="w-64 h-24 border-2 border-green-500 relative bg-transparent shadow-[0_0_0_9999px_rgba(0,0,0,0.6)]">
                    <div class="scan-line"></div>
                    <div class="absolute top-0 left-0 w-4 h-4 border-t-4 border-l-4 border-green-500 -mt-1 -ml-1"></div>
                    <div class="absolute top-0 right-0 w-4 h-4 border-t-4 border-r-4 border-green-500 -mt-1 -mr-1"></div>
                    <div class="absolute bottom-0 left-0 w-4 h-4 border-b-4 border-l-4 border-green-500 -mb-1 -ml-1"></div>
                    <div class="absolute bottom-0 right-0 w-4 h-4 border-b-4 border-r-4 border-green-500 -mb-1 -mr-1"></div>
                </div>
                <div class="flex-1 bg-black/60"></div>
            </div>
            <div class="flex-1 bg-black/60 flex flex-col items-center pt-8">
                <p class="text-gray-300 text-sm mb-1 font-medium bg-black/40 px-3 py-1 rounded-full">将单词放入框内</p>
            </div>
        </div>

        <div class="absolute bottom-10 z-20 w-full flex justify-center items-center pointer-events-auto">
            <button id="snap-btn" class="w-20 h-20 rounded-full bg-white border-4 border-gray-300 flex items-center justify-center active:scale-95 transition-transform shadow-lg group">
                <div class="w-16 h-16 rounded-full bg-white border-2 border-black group-active:bg-gray-200 transition-colors"></div>
            </button>
        </div>
        
        <div id="loading-overlay" class="absolute inset-0 bg-black/80 z-50 hidden flex flex-col items-center justify-center">
            <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-white mb-4"></div>
            <p id="loading-text" class="text-white font-medium">正在识别...</p>
            <p class="text-gray-400 text-xs mt-2">正在优化图像清晰度...</p>
        </div>
    </div>

    <!-- ==================== 页面 2: 结果展示 ==================== -->
    <div id="result-view" class="absolute inset-0 z-30 bg-gray-50 text-gray-800 hidden flex flex-col h-full">
        <!-- 顶部导航 -->
        <div class="bg-white px-4 py-3 shadow-sm flex items-center justify-between shrink-0 z-10">
            <button id="back-btn" class="text-gray-600 text-lg p-2 active:text-gray-900">
                <i class="fas fa-chevron-left"></i> 返回
            </button>
            <h1 class="font-bold text-lg text-gray-800">识别结果</h1>
            <div class="w-10"></div>
        </div>

        <div class="flex-1 overflow-y-auto p-4 hide-scrollbar pb-20">
            
            <!-- 图像预览 -->
            <div class="flex flex-col items-center mb-6">
                <div class="relative">
                    <img id="captured-img" class="h-16 object-contain border border-gray-200 rounded-lg shadow-sm bg-gray-100" src="" alt="Captured Word">
                    <div class="absolute -bottom-2 -right-2 bg-green-100 text-green-700 text-[10px] px-2 py-0.5 rounded-full border border-green-200 shadow-sm">
                        已增强
                    </div>
                </div>
            </div>

            <!-- 单词卡片 (可编辑) -->
            <div class="bg-white rounded-xl shadow-md p-6 mb-4 text-center">
                <div class="relative mb-2">
                    <label class="text-xs text-gray-400 block mb-1">点击文字可修改</label>
                    <input type="text" id="result-word-input" 
                           class="editable-word text-3xl font-bold text-gray-800 p-1 rounded" 
                           value="--" spellcheck="false">
                    <i class="fas fa-pen absolute right-0 top-1/2 -translate-y-1/2 text-gray-300 text-sm pointer-events-none"></i>
                </div>
                
                <div class="flex justify-center mt-5 space-x-3">
                    <button id="copy-btn" class="flex-1 flex items-center justify-center space-x-2 bg-gray-100 text-gray-700 px-4 py-3 rounded-xl font-medium active:bg-gray-200 transition">
                        <i class="fas fa-copy"></i>
                        <span>复制</span>
                    </button>
                    <button id="speak-btn" class="flex-1 flex items-center justify-center space-x-2 bg-purple-50 text-purple-600 px-4 py-3 rounded-xl font-medium active:bg-purple-100 transition">
                        <i class="fas fa-volume-up"></i>
                        <span>发音</span>
                    </button>
                </div>
            </div>

            <!-- 搜索结果 -->
            <div class="bg-white rounded-xl shadow-md p-5">
                <div class="flex items-center justify-between mb-4 border-b pb-3 border-gray-100">
                    <h3 class="font-bold text-gray-700 flex items-center">
                        <i class="fas fa-book-open text-blue-500 mr-2"></i> 释义
                    </h3>
                </div>
                
                <div id="api-definition" class="text-sm text-gray-600 mb-6 leading-relaxed min-h-[50px]">
                    正在加载...
                </div>

                <a id="bing-link" href="#" target="_blank" class="flex items-center justify-center w-full bg-[#00809d] text-white py-3.5 rounded-xl font-bold shadow-md hover:bg-[#006d85] active:scale-[0.98] transition">
                    <span>Bing 详细释义</span>
                    <i class="fas fa-chevron-right ml-2 text-xs opacity-70"></i>
                </a>
            </div>
        </div>
    </div>

    <canvas id="canvas" class="hidden"></canvas>

    <script>
        const video = document.getElementById('video-feed');
        const canvas = document.getElementById('canvas');
        const snapBtn = document.getElementById('snap-btn');
        const scanBox = document.getElementById('scan-box');
        const cameraView = document.getElementById('camera-view');
        const resultView = document.getElementById('result-view');
        const loadingOverlay = document.getElementById('loading-overlay');
        const loadingText = document.getElementById('loading-text');
        
        const capturedImg = document.getElementById('captured-img');
        const resultInput = document.getElementById('result-word-input');
        const copyBtn = document.getElementById('copy-btn');
        const speakBtn = document.getElementById('speak-btn');
        const backBtn = document.getElementById('back-btn');
        const apiDefinitionEl = document.getElementById('api-definition');
        const bingLink = document.getElementById('bing-link');

        let stream = null;

        async function initCamera() {
            try {
                stream = await navigator.mediaDevices.getUserMedia({ 
                    video: { 
                        facingMode: "environment",
                        width: { ideal: 1920 },
                        height: { ideal: 1080 } 
                    } 
                });
                video.srcObject = stream;
                await video.play();
            } catch (err) {
                alert("无法访问摄像头，请检查权限或HTTPS环境。\n" + err.message);
            }
        }

        // --- 图像增强算法 ---
        function applyImageEnhancement(ctx, width, height) {
            const imageData = ctx.getImageData(0, 0, width, height);
            const data = imageData.data;
            
            // 提高对比度的系数 (1.0 是原图，>1.0 增加对比度)
            const contrast = 1.8; 
            const intercept = 128 * (1 - contrast);

            for (let i = 0; i < data.length; i += 4) {
                const r = data[i];
                const g = data[i + 1];
                const b = data[i + 2];
                
                // 1. 灰度化 (Grayscale)
                // 使用亮度公式: 0.299R + 0.587G + 0.114B
                let gray = 0.299 * r + 0.587 * g + 0.114 * b;
                
                // 2. 对比度增强 (Contrast Enhancement)
                // 这一步能让浅色的字变得更深，模糊的背景变白
                gray = gray * contrast + intercept;
                
                // 截断值范围 0-255
                gray = Math.max(0, Math.min(255, gray));

                // 3. 将处理后的灰度值写回 RGB 通道
                data[i] = gray;     // R
                data[i+1] = gray;   // G
                data[i+2] = gray;   // B
                // Alpha (data[i+3]) 保持不变
            }
            ctx.putImageData(imageData, 0, 0);
        }

        snapBtn.addEventListener('click', async () => {
            if (!video.videoWidth) return;
            loadingOverlay.classList.remove('hidden');
            loadingText.textContent = "图像增强处理中...";

            const videoRect = video.getBoundingClientRect();
            const boxRect = scanBox.getBoundingClientRect();

            // 1. 全屏截图
            const ctx = canvas.getContext('2d');
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

            // 2. 计算裁剪坐标 (处理 object-fit: cover)
            const displayAspect = videoRect.width / videoRect.height;
            const videoAspect = video.videoWidth / video.videoHeight;
            
            let renderWidth, renderHeight, xOffset, yOffset;

            if (displayAspect > videoAspect) {
                renderWidth = videoRect.width;
                renderHeight = videoRect.width / videoAspect;
                xOffset = 0;
                yOffset = (videoRect.height - renderHeight) / 2;
            } else {
                renderHeight = videoRect.height;
                renderWidth = videoRect.height * videoAspect;
                yOffset = 0;
                xOffset = (videoRect.width - renderWidth) / 2;
            }

            const boxX = boxRect.left - videoRect.left - xOffset;
            const boxY = boxRect.top - videoRect.top - yOffset;
            const scale = video.videoWidth / renderWidth;
            
            const sourceX = Math.max(0, boxX * scale);
            const sourceY = Math.max(0, boxY * scale);
            const sourceW = boxRect.width * scale;
            const sourceH = boxRect.height * scale;

            // 3. 裁剪
            const cropCanvas = document.createElement('canvas');
            cropCanvas.width = sourceW;
            cropCanvas.height = sourceH;
            const cropCtx = cropCanvas.getContext('2d');
            cropCtx.drawImage(canvas, sourceX, sourceY, sourceW, sourceH, 0, 0, sourceW, sourceH);

            // 4. 应用图像增强 (关键步骤)
            applyImageEnhancement(cropCtx, sourceW, sourceH);

            // 5. 生成图片用于识别
            const dataUrl = cropCanvas.toDataURL('image/png');
            capturedImg.src = dataUrl;

            performOCR(dataUrl);
        });

        async function performOCR(imageSrc) {
            loadingText.textContent = "OCR 智能识别中...";
            
            try {
                const { data: { text } } = await Tesseract.recognize(
                    imageSrc,
                    'eng', 
                    { 
                        // 使用单个文本块模式，适合单词识别
                        tessedit_pageseg_mode: Tesseract.PSM.SINGLE_BLOCK,
                    }
                );

                // 清理结果: 替换换行，保留字母、数字和空格
                let cleanedText = text.replace(/[\r\n]+/g, ' ').replace(/[^a-zA-Z0-9\s]/g, ' ').trim();
                let words = cleanedText.split(/\s+/).filter(w => w.length > 0);

                if (words.length === 0) {
                    // 如果增强后还识别不出，尝试宽容模式提示用户
                    resultInput.value = "";
                    resultInput.placeholder = "未识别到单词，请点击输入";
                    showResultView("");
                    return; 
                }

                // 取第一个看起来像单词的结果
                const targetWord = words[0];
                showResultView(targetWord);

            } catch (err) {
                console.error(err);
                alert("识别出错，请重试或手动输入。");
                loadingOverlay.classList.add('hidden');
            }
        }

        function showResultView(word) {
            cameraView.classList.add('hidden');
            resultView.classList.remove('hidden');
            loadingOverlay.classList.add('hidden');

            resultInput.value = word;
            updateExternalLinks(word);
            if(word) fetchDefinition(word);
            else apiDefinitionEl.textContent = "请点击上方文字进行修改";
        }

        function updateExternalLinks(word) {
            bingLink.href = `https://cn.bing.com/dict/search?q=${encodeURIComponent(word)}`;
        }

        // 监听输入框修改，修改完成后（失去焦点或回车）更新释义
        resultInput.addEventListener('change', () => {
            const newWord = resultInput.value.trim();
            if(newWord) {
                updateExternalLinks(newWord);
                fetchDefinition(newWord);
            }
        });
        
        resultInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                resultInput.blur(); // 触发 change 事件
            }
        });

        async function fetchDefinition(word) {
            apiDefinitionEl.innerHTML = '<span class="text-gray-400 flex items-center"><i class="fas fa-spinner fa-spin mr-2"></i> 正在查询释义...</span>';
            
            try {
                // 处理一些常见情况，比如用户输入了空格
                const cleanWord = word.split(' ')[0]; 
                const response = await fetch(`https://api.dictionaryapi.dev/api/v2/entries/en/${cleanWord}`);
                
                if (!response.ok) throw new Error("No Definition");
                
                const data = await response.json();
                const firstEntry = data[0];
                const firstMeaning = firstEntry.meanings[0];
                const definition = firstMeaning.definitions[0].definition;
                const partOfSpeech = firstMeaning.partOfSpeech;
                const phonetic = firstEntry.phonetic || "";

                apiDefinitionEl.innerHTML = `
                    <div class="mb-2">
                        <span class="text-xs bg-gray-200 text-gray-600 px-2 py-0.5 rounded mr-2">${partOfSpeech}</span>
                        <span class="text-gray-500 font-mono text-xs">${phonetic}</span>
                    </div>
                    <p class="text-gray-800 leading-relaxed">${definition}</p>
                `;
            } catch (e) {
                apiDefinitionEl.innerHTML = `
                    <div class="text-gray-500 text-sm">
                        <p class="mb-2">暂无简明释义。</p>
                        <p class="text-xs">提示：点击下方蓝色按钮查看 Bing 完整结果。</p>
                    </div>`;
            }
        }

        backBtn.addEventListener('click', () => {
            resultView.classList.add('hidden');
            cameraView.classList.remove('hidden');
            resultInput.value = "--";
            apiDefinitionEl.textContent = "";
        });

        copyBtn.addEventListener('click', () => {
            const text = resultInput.value;
            if(!text) return;
            navigator.clipboard.writeText(text).then(() => {
                const originalHTML = copyBtn.innerHTML;
                copyBtn.innerHTML = '<i class="fas fa-check text-green-500"></i> <span class="text-green-600">已复制</span>';
                copyBtn.classList.add('bg-green-50');
                setTimeout(() => {
                    copyBtn.innerHTML = originalHTML;
                    copyBtn.classList.remove('bg-green-50');
                }, 1500);
            });
        });

        speakBtn.addEventListener('click', () => {
            const text = resultInput.value;
            if(!text) return;
            const utterance = new SpeechSynthesisUtterance(text);
            utterance.lang = 'en-US';
            window.speechSynthesis.speak(utterance);
        });

        window.addEventListener('load', initCamera);

    </script>
</body>
</html>
