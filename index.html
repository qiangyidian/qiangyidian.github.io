<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å•è¯æå– V5 (è‰²å½©å·®å€¼+ç›´æ–¹å›¾ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: #f1f5f9; color: #334155; }
        .custom-scrollbar::-webkit-scrollbar { width: 6px; }
        .custom-scrollbar::-webkit-scrollbar-track { background: transparent; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 20px; }
        
        .tag { font-size: 9px; padding: 1px 4px; border-radius: 4px; font-weight: 600; margin-left: 4px; }
        .tag-cyan { background: #cffafe; color: #0891b2; border: 1px solid #22d3ee; }
        .tag-pos { background: #f0fdf4; color: #166534; border: 1px solid #86efac; }
        .tag-size { background: #fff7ed; color: #9a3412; border: 1px solid #fdba74; }

        #camera-modal { position: fixed; inset: 0; background: black; z-index: 100; display: none; flex-direction: column; }
    </style>
</head>
<body class="h-screen flex flex-col">

    <!-- é¡¶éƒ¨ -->
    <header class="bg-white border-b border-slate-200 px-4 py-3 flex justify-between items-center shadow-sm z-10">
        <div class="flex items-center gap-3">
            <div class="w-9 h-9 bg-cyan-600 rounded-lg flex items-center justify-center text-white shadow-lg shadow-cyan-200">
                <i class="fa-solid fa-wand-magic-sparkles"></i>
            </div>
            <div>
                <h1 class="text-sm font-bold text-slate-800">å•è¯æå– V5</h1>
                <p class="text-[10px] text-slate-500">RGBå·®å€¼ç®—æ³• + ç›´æ–¹å›¾å¯¹é½</p>
            </div>
        </div>
        <div class="text-[10px] font-mono text-slate-400">Queue: <span id="queue-count" class="font-bold text-cyan-600">0</span></div>
    </header>

    <!-- ä¸»ç•Œé¢ -->
    <main class="flex-1 flex overflow-hidden">
        
        <!-- å·¦ä¾§æ§åˆ¶åŒº -->
        <div class="w-1/3 min-w-[280px] max-w-sm bg-white border-r border-slate-200 flex flex-col z-0">
            <!-- æŒ‰é’® -->
            <div class="p-3 grid grid-cols-2 gap-2 border-b border-slate-100">
                <button onclick="document.getElementById('file-input').click()" class="btn-tool bg-slate-50 hover:bg-cyan-50 border border-slate-200 hover:border-cyan-200 text-slate-600 hover:text-cyan-700 rounded-lg p-3 flex flex-col items-center gap-1 transition">
                    <i class="fa-solid fa-folder-open text-xl"></i>
                    <span class="text-xs font-medium">ç›¸å†Œ</span>
                    <input type="file" id="file-input" accept="image/*" multiple class="hidden" onchange="handleFiles(this.files)">
                </button>
                <button onclick="openCamera()" class="btn-tool bg-slate-50 hover:bg-cyan-50 border border-slate-200 hover:border-cyan-200 text-slate-600 hover:text-cyan-700 rounded-lg p-3 flex flex-col items-center gap-1 transition">
                    <i class="fa-solid fa-camera text-xl"></i>
                    <span class="text-xs font-medium">æ‹ç…§</span>
                </button>
            </div>

            <!-- åˆ—è¡¨ -->
            <div id="image-list" class="flex-1 overflow-y-auto p-3 space-y-2 custom-scrollbar bg-slate-50">
                <div id="empty-hint" class="h-full flex flex-col items-center justify-center text-slate-300 opacity-60">
                    <i class="fa-regular fa-image text-3xl mb-2"></i>
                    <span class="text-xs">æš‚æ— å›¾ç‰‡</span>
                </div>
            </div>

            <!-- è®¾ç½®ä¸æ‰§è¡Œ -->
            <div class="p-3 bg-white border-t border-slate-200">
                <div class="mb-3 px-1">
                    <label class="flex items-center justify-between text-xs text-slate-500 cursor-pointer">
                        <span>æ˜¾ç¤ºå¤„ç†ç»†èŠ‚ (è°ƒè¯•)</span>
                        <input type="checkbox" id="debug-mode" class="accent-cyan-600">
                    </label>
                </div>
                <button id="run-btn" onclick="runPipeline()" class="w-full bg-cyan-600 hover:bg-cyan-700 text-white py-3 rounded-xl font-bold shadow-lg shadow-cyan-200 transition-all active:scale-[0.98] flex items-center justify-center gap-2 disabled:opacity-50 disabled:grayscale">
                    <i class="fa-solid fa-bolt"></i> å¼€å§‹æé€Ÿåˆ†æ
                </button>
            </div>
        </div>

        <!-- å³ä¾§ç»“æœåŒº -->
        <div class="flex-1 flex flex-col bg-slate-100 relative">
            
            <div class="h-10 bg-white border-b border-slate-200 flex justify-between items-center px-4">
                <span class="text-xs font-bold text-slate-500 uppercase tracking-wider">Result</span>
                <div class="flex gap-2">
                    <button onclick="copyResult()" class="text-xs px-2 py-1 hover:bg-slate-100 rounded text-slate-600 transition"><i class="fa-regular fa-copy"></i> å¤åˆ¶</button>
                    <button onclick="downloadResult()" class="text-xs px-2 py-1 hover:bg-slate-100 rounded text-slate-600 transition"><i class="fa-solid fa-download"></i> TXT</button>
                </div>
            </div>

            <div class="flex-1 relative">
                <textarea id="output-area" class="w-full h-full p-6 resize-none focus:outline-none font-mono text-sm leading-relaxed bg-transparent text-slate-800" placeholder="ç­‰å¾…åˆ†æ..."></textarea>
                
                <!-- åŠ è½½é®ç½© -->
                <div id="processing-mask" class="absolute inset-0 bg-white/80 backdrop-blur-sm z-10 flex flex-col items-center justify-center hidden">
                    <div class="w-10 h-10 border-4 border-slate-200 border-t-cyan-500 rounded-full animate-spin mb-3"></div>
                    <div id="status-text" class="text-xs font-bold text-cyan-700">å‡†å¤‡å°±ç»ª</div>
                    <div class="w-40 h-1 bg-slate-200 rounded-full mt-2 overflow-hidden">
                        <div id="progress-bar" class="h-full bg-cyan-500 transition-all duration-300 w-0"></div>
                    </div>
                </div>
            </div>

            <!-- è°ƒè¯•æ—¥å¿— -->
            <div id="debug-panel" class="h-1/3 bg-slate-900 text-slate-400 p-3 font-mono text-[10px] overflow-y-auto hidden border-t border-slate-800"></div>
        </div>
    </main>

    <!-- ç›¸æœºæ¨¡æ€æ¡† -->
    <div id="camera-modal">
        <video id="cam-video" autoplay playsinline class="flex-1 object-cover"></video>
        <div class="absolute top-0 w-full p-4 flex justify-between text-white z-20">
            <span class="bg-black/50 px-2 py-1 rounded text-xs backdrop-blur">é˜Ÿåˆ—: <span id="cam-count">0</span></span>
            <button onclick="closeCamera()"><i class="fa-solid fa-xmark text-2xl drop-shadow"></i></button>
        </div>
        <!-- ç›¸æœºè¾…åŠ©çº¿ -->
        <div class="absolute inset-0 pointer-events-none flex items-center justify-center">
            <div class="w-[2px] h-full bg-cyan-400/50 absolute left-[15%]"></div> <!-- å¼ºè¿«å·¦å¯¹é½çº¿ -->
            <div class="absolute left-[16%] top-1/2 text-cyan-400/80 text-xs -rotate-90 origin-left">è¯·å°†å•è¯å¯¹é½æ­¤çº¿</div>
        </div>
        <div class="h-24 bg-black flex justify-center items-center relative z-20">
            <button onclick="takePhoto()" class="w-16 h-16 rounded-full border-4 border-white/30 bg-white active:scale-90 transition"></button>
        </div>
        <canvas id="cam-canvas" class="hidden"></canvas>
    </div>

    <!-- å¤„ç†ç”¨ç”»å¸ƒ -->
    <canvas id="proc-canvas" class="hidden"></canvas>

    <script>
        const state = { queue: [], worker: null };
        const dom = {
            output: document.getElementById('output-area'),
            mask: document.getElementById('processing-mask'),
            status: document.getElementById('status-text'),
            prog: document.getElementById('progress-bar'),
            debug: document.getElementById('debug-panel')
        };

        // --- V5 æ ¸å¿ƒç®—æ³• ---

        // 1. å¼ºåŠ›æ¸…æ´—å‡½æ•° (é’ˆå¯¹ interim'mtorm ç­‰ç²˜è¿é—®é¢˜)
        function cleanText(text) {
            text = text.trim();
            // åªè¦é‡åˆ°è¿™äº›ç¬¦å·ï¼Œè®¤ä¸ºåé¢éƒ½æ˜¯å¹²æ‰°é¡¹ï¼ˆéŸ³æ ‡ã€ä¾‹å¥èµ·å§‹ç­‰ï¼‰ï¼Œç›´æ¥æˆªæ–­
            const cutoffChars = ['\'', 'â€™', '[', '(', 'ã€', '/']; 
            for (let char of cutoffChars) {
                const idx = text.indexOf(char);
                if (idx !== -1) {
                    text = text.substring(0, idx);
                }
            }
            // æ¸…ç†é¦–å°¾éå­—æ¯
            text = text.replace(/^[^a-zA-Z]+|[^a-zA-Z]+$/g, '');
            return text;
        }

        // 2. è‰²å½©å·®å€¼ç®—æ³• (Score = (G+B) - 2R)
        // ä¸“é—¨å¯¹æŠ—é»‘è‰²/ç°è‰²é˜´å½±ã€‚é’è‰²å¢¨æ°´ï¼šGå’ŒBé«˜ï¼ŒRä½ -> åˆ†æ•°é«˜ã€‚é˜´å½±/é»‘è‰²ï¼šRGBå‡è¡¡ -> åˆ†æ•°æ¥è¿‘0ã€‚
        function analyzeColorV5(ctx, bbox) {
            const w = bbox.x1 - bbox.x0, h = bbox.y1 - bbox.y0;
            if (w <= 0 || h <= 0) return 0;
            
            const data = ctx.getImageData(bbox.x0, bbox.y0, w, h).data;
            let totalScore = 0, pixels = 0;

            for (let i = 0; i < data.length; i += 4) { // é‡‡æ ·æ­¥é•¿æ”¹ä¸º1ï¼Œç²¾åº¦æ›´é«˜
                const r = data[i], g = data[i+1], b = data[i+2];
                // ä»…è®¡ç®—æ·±è‰²åƒç´  (äº®åº¦ < 220)ï¼Œå¿½ç•¥ç™½çº¸èƒŒæ™¯
                if ((r+g+b)/3 < 220) {
                    // æ ¸å¿ƒå…¬å¼ï¼šé’è‰²å¼ºåº¦ = (ç»¿+è“) - 2*çº¢
                    // ç†æƒ³é’è‰² (0,255,255) -> (255+255) - 0 = 510
                    // é»‘è‰² (50,50,50) -> (50+50) - 100 = 0
                    const score = (g + b) - (2.0 * r); 
                    if (score > 30) { // é˜ˆå€¼30ï¼Œè¿‡æ»¤æ‰ä¸€èˆ¬çš„ç°è‰²å™ªç‚¹
                        totalScore += score;
                        pixels++;
                    }
                }
            }
            return pixels > 0 ? (totalScore / pixels) : 0;
        }

        // 3. ç›´æ–¹å›¾å¸ƒå±€åˆ†æ (å¯»æ‰¾çœŸæ­£çš„å·¦è¾¹è·)
        function findLeftMarginMode(words) {
            if (words.length === 0) return 0;
            
            // å»ºç«‹ 10px å®½åº¦çš„æ¡¶
            const binSize = 10;
            const bins = {};
            
            words.forEach(w => {
                // æ’é™¤æ˜æ˜¾åœ¨å³ä¾§çš„è¯(å¦‚é¡µç )å’Œæå·¦å™ªç‚¹
                if (w.bbox.x0 > 5) {
                    const bin = Math.floor(w.bbox.x0 / binSize) * binSize;
                    bins[bin] = (bins[bin] || 0) + 1;
                }
            });

            // æ‰¾åˆ°åŒ…å«å•è¯æœ€å¤šçš„é‚£ä¸ªæ¡¶ (ä¼—æ•°)
            let maxCount = 0;
            let bestBin = 0;
            
            // åªçœ‹å·¦ä¾§ 30% åŒºåŸŸçš„æ¡¶ (å‡è®¾å•è¯å¯¹é½åœ¨å·¦ä¾§)
            // ç®€å•ç‚¹ï¼Œç›´æ¥æ‰¾ count æœ€å¤§çš„æ¡¶ï¼Œé€šå¸¸å°±æ˜¯å·¦å¯¹é½çº¿
            for (const [bin, count] of Object.entries(bins)) {
                if (count > maxCount) {
                    maxCount = count;
                    bestBin = parseInt(bin);
                }
            }
            return bestBin;
        }

        // --- ä¸»ç®¡çº¿ ---
        async function runPipeline() {
            if (state.queue.length === 0) return alert("è¯·æ·»åŠ å›¾ç‰‡");
            
            updateUI(true);
            const isDebug = document.getElementById('debug-mode').checked;
            if(isDebug) dom.debug.classList.remove('hidden');
            dom.debug.innerHTML = '';
            dom.output.value = '';
            
            let finalOutput = "";

            try {
                if (!state.worker) {
                    dom.status.innerText = "åŠ è½½è¯†åˆ«æ¨¡å‹...";
                    state.worker = await Tesseract.createWorker('eng');
                    // ç™½åå•åªå…è®¸å­—æ¯å’ŒåŸºæœ¬æ ‡ç‚¹ï¼Œé˜²æ­¢å¥‡æ€ªçš„ç¬¦å·
                    await state.worker.setParameters({
                        tessedit_pageseg_mode: Tesseract.PSM.SPARSE_TEXT,
                        tessedit_char_whitelist: "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ1234567890'/-[]()" 
                    });
                }

                for (let i = 0; i < state.queue.length; i++) {
                    const item = state.queue[i];
                    updateProgress((i/state.queue.length)*100, `å¤„ç†å›¾ç‰‡ ${i+1}...`);

                    // 1. OCR
                    const { data: { words } } = await state.worker.recognize(item.src);

                    // 2. å›¾åƒä¸Šä¸‹æ–‡
                    const img = new Image(); img.src = item.src; await new Promise(r => img.onload = r);
                    const cvs = document.getElementById('proc-canvas');
                    const ctx = cvs.getContext('2d', { willReadFrequently: true });
                    cvs.width = img.width; cvs.height = img.height;
                    ctx.drawImage(img, 0, 0);

                    // 3. è®¡ç®—å·¦è¾¹è·åŸºå‡†çº¿ (Mode)
                    const leftMode = findLeftMarginMode(words);
                    const leftTolerance = 20; // å…è®¸ 20px çš„è¯¯å·® (é’ˆå¯¹æ‰‹æŠ–/å¼¯æ›²)

                    // 4. è®¡ç®—å­—å·åŸºå‡† (Median Height)
                    const heights = words.map(w => w.bbox.y1 - w.bbox.y0).sort((a,b)=>a-b);
                    const medianH = heights[Math.floor(heights.length/2)] || 20;

                    let pageResult = [];
                    if(isDebug) log(`[IMG ${i+1}] LeftMode:${leftMode}px, MedianH:${medianH}px`);

                    for (const w of words) {
                        let rawText = w.text;
                        let text = cleanText(rawText);
                        
                        if (text.length < 3) continue;
                        // è¿‡æ»¤å¸¸è§ä¾‹å¥ä»‹è¯ (é™¤éé¢œè‰²æå…¶åŒ¹é…)
                        if (/^(The|This|That|With|For|And|But|When|If)$/i.test(text)) {
                             // æš‚æ—¶æ ‡è®°ï¼Œçœ‹åé¢é¢œè‰²åˆ†å¤Ÿä¸å¤Ÿé«˜
                        }

                        // A. ä½ç½®æ£€æŸ¥
                        const dist = Math.abs(w.bbox.x0 - leftMode);
                        const isAligned = dist <= leftTolerance;
                        
                        // B. é¢œè‰²æ£€æŸ¥ (V5 æ ¸å¿ƒ)
                        const colorScore = analyzeColorV5(ctx, w.bbox);
                        // ç»éªŒå€¼ï¼šé’è‰²å­—é€šå¸¸ > 50ï¼Œé»‘è‰²å­— < 10
                        const isCyan = colorScore > 40; 
                        
                        // C. å­—å·æ£€æŸ¥
                        const h = w.bbox.y1 - w.bbox.y0;
                        const isBig = h > medianH * 1.1;

                        // --- ç»¼åˆå†³ç­– ---
                        let pass = false;
                        let reasons = [];

                        // è§„åˆ™1ï¼šå¦‚æœé¢œè‰²å¾ˆé’ï¼Œç›´æ¥é€šè¿‡ (å“ªæ€•ä½ç½®ç¨å¾®åä¸€ç‚¹)
                        if (isCyan) {
                            pass = true;
                            reasons.push('Color');
                        }
                        // è§„åˆ™2ï¼šå¦‚æœä½ç½®å®Œç¾å¯¹é½ + å­—å·åå¤§ (é˜²æ­¢é»‘è‰²ä¾‹å¥é¦–è¯æ··å…¥)
                        else if (isAligned && isBig) {
                            // å¿…é¡»ä¸æ˜¯çº¯é»‘ (colorScore > 5) é˜²æ­¢æ ‡é¢˜æ çš„é»‘è‰²å¤§å­—
                            if (colorScore > 5) {
                                pass = true;
                                reasons.push('Pos+Size');
                            }
                        }
                        // è§„åˆ™3ï¼šä½ç½®å®Œç¾ + æœ‰ä¸€ç‚¹ç‚¹é¢œè‰²å€¾å‘ (è¡¥æ•‘å…‰çº¿æš—çš„æƒ…å†µ)
                        else if (isAligned && colorScore > 15) {
                            pass = true;
                            reasons.push('Pos+WeakColor');
                        }

                        // ç¡¬è¿‡æ»¤ï¼šå¦‚æœå•è¯å« "With" ä¸”é¢œè‰²åˆ†ä¸é«˜ï¼Œæ€æ‰
                        if (/^(With|The|In)$/i.test(text) && colorScore < 80) pass = false;

                        if (pass) {
                            // å»é‡
                            if (!pageResult.includes(text)) {
                                pageResult.push(text);
                                if(isDebug) log(`MATCH: ${text.padEnd(15)} | ğŸŸ¢ Score:${colorScore.toFixed(0)} | ${reasons.join('+')}`);
                            }
                        } else {
                            if(isDebug && isAligned) log(`SKIP : ${text.padEnd(15)} | âš« Score:${colorScore.toFixed(0)} | IsBig:${isBig}`);
                        }
                    }

                    if (pageResult.length > 0) finalOutput += pageResult.join('\n') + '\n';
                }
                
                dom.output.value = finalOutput;
                updateProgress(100, "å®Œæˆ");

            } catch(e) {
                alert("é”™è¯¯: " + e.message);
            } finally {
                updateUI(false);
            }
        }

        // --- UI / Helper ---
        function updateUI(busy) {
            dom.mask.classList.toggle('hidden', !busy);
            document.getElementById('run-btn').disabled = busy;
        }
        function updateProgress(val, txt) {
            dom.prog.style.width = val + '%';
            dom.status.innerText = txt;
        }
        function log(msg) {
            const d = document.createElement('div');
            d.innerText = msg;
            d.className = msg.startsWith('MATCH') ? 'text-cyan-400' : 'text-slate-500';
            dom.debug.appendChild(d);
        }

        function handleFiles(files) {
            Array.from(files).forEach(f => {
                const r = new FileReader();
                r.onload = e => {
                    state.queue.push({src: e.target.result});
                    renderQueue();
                };
                r.readAsDataURL(f);
            });
            document.getElementById('file-input').value = '';
        }

        function renderQueue() {
            document.getElementById('queue-count').innerText = state.queue.length;
            const list = document.getElementById('image-list');
            list.innerHTML = '';
            if(state.queue.length === 0) {
                list.innerHTML = `<div class="h-full flex flex-col items-center justify-center text-slate-300 opacity-60"><i class="fa-regular fa-image text-3xl mb-2"></i><span class="text-xs">æš‚æ— å›¾ç‰‡</span></div>`;
                return;
            }
            state.queue.forEach((img, i) => {
                const div = document.createElement('div');
                div.className = 'flex items-center gap-3 bg-white p-2 rounded-lg border border-slate-200 shadow-sm';
                div.innerHTML = `
                    <div class="w-10 h-10 bg-slate-100 rounded overflow-hidden flex-shrink-0"><img src="${img.src}" class="w-full h-full object-cover"></div>
                    <div class="flex-1 text-xs font-bold text-slate-700">å›¾ç‰‡ #${i+1}</div>
                    <button onclick="state.queue.splice(${i},1);renderQueue()" class="text-slate-400 hover:text-red-500 px-2"><i class="fa-solid fa-trash"></i></button>
                `;
                list.appendChild(div);
            });
        }

        // ç›¸æœºç›¸å…³
        let stream;
        function openCamera() {
            document.getElementById('camera-modal').style.display = 'flex';
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(s => { stream = s; document.getElementById('cam-video').srcObject = s; })
                .catch(() => alert('æ— æ³•è®¿é—®ç›¸æœº'));
        }
        function closeCamera() {
            document.getElementById('camera-modal').style.display = 'none';
            if(stream) stream.getTracks().forEach(t => t.stop());
        }
        function takePhoto() {
            const vid = document.getElementById('cam-video');
            const cvs = document.getElementById('cam-canvas');
            cvs.width = vid.videoWidth; cvs.height = vid.videoHeight;
            cvs.getContext('2d').drawImage(vid, 0, 0);
            state.queue.push({src: cvs.toDataURL('image/jpeg')});
            renderQueue();
            
            // åŠ¨ç”»åé¦ˆ
            const btn = document.querySelector('#camera-modal button[onclick="takePhoto()"]');
            btn.style.transform = 'scale(0.8)';
            setTimeout(() => btn.style.transform = 'scale(1)', 100);
        }

        function copyResult() { navigator.clipboard.writeText(dom.output.value).then(()=>alert('å·²å¤åˆ¶')); }
        function downloadResult() {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([dom.output.value], {type:'text/plain'}));
            a.download = `words_${Date.now()}.txt`;
            a.click();
        }
    </script>
</body>
</html>
